name: Android CI

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BUILD_TOOLS: 34.0.0
      COMPILE_SDK: 34
      APK_PREFIX: NuYouPlus

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Extract your ZIP (new name)
      - name: Extract NuYou project ZIP
        shell: bash
        run: |
          set -e
          echo "Looking for NuYou_PDF_Text_Replacer_Signed.zip at repo root..."
          if [ -f "NuYou_PDF_Text_Replacer_Signed.zip" ]; then
            unzip -q "NuYou_PDF_Text_Replacer_Signed.zip" -d extracted
            echo "Unzipped into ./extracted"
          else
            echo "ZIP not found; will assume project already present."
          fi
          echo "Top-level after extraction:"
          ls -lah

      # 2) Auto-detect the project dir (where gradlew lives)
      - name: Detect Gradle project
        id: detect
        shell: bash
        run: |
          set -e
          CANDIDATE=$(find . -maxdepth 5 -type f -name gradlew | head -n1 || true)
          if [ -z "$CANDIDATE" ]; then
            echo "::error::No gradlew found. Ensure your ZIP contains a Gradle Android project."
            echo "Repository tree for debugging:"; find . -maxdepth 3 -print
            exit 1
          fi
          PROJECT_DIR=$(dirname "$CANDIDATE")
          echo "Detected project dir: $PROJECT_DIR"
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV
          chmod +x "$PROJECT_DIR/gradlew"
          echo "Contents of project dir:"; ls -lah "$PROJECT_DIR"

      # 3) JDK
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # 4) Android SDK
      - name: Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          cmdline-tools-version: 11076708
          packages: |
            platform-tools
            platforms;android-34
            build-tools;34.0.0

      # 5) Version info
      - name: Print Android/Java versions
        run: |
          java -version
          adb version || true
          sdkmanager --version || true

      # 6) Build (release if available, else debug)
      - name: Build APK
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          ./gradlew --no-daemon assembleRelease || ./gradlew --no-daemon assembleDebug

      # 7) Pick the largest APK
      - name: Collect APKs
        id: apks
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          set -e
          mapfile -t APKS < <(find . -type f -path "*/build/outputs/apk/*/*.apk")
          if [ ${#APKS[@]} -eq 0 ]; then
            echo "::error::No APKs produced."; find . -maxdepth 5 -type d -path "*/build/outputs/apk" -print
            exit 1
          fi
          printf "Found APKs:\n"; ls -lh "${APKS[@]}"
          BIGGEST=$(ls -S "${APKS[@]}" | head -n1)
          echo "Selected APK: $BIGGEST"
          echo "UNSIGNED_APK=$BIGGEST" >> $GITHUB_ENV

      # 8) Zipalign
      - name: Zipalign
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          "$ANDROID_HOME/build-tools/${{ env.BUILD_TOOLS }}/zipalign" -p -f 4 \
            "$UNSIGNED_APK" aligned.apk
          echo "ALIGNED_APK=$PWD/aligned.apk" >> $GITHUB_ENV
          ls -lh aligned.apk

      # 9) Create debug keystore
      - name: Create debug keystore
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          keytool -genkeypair -v \
            -keystore debug.keystore -storepass android \
            -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=NuYouPlus,O=NuYouPlus,C=US"
          echo "DEBUG_KEYSTORE=$PWD/debug.keystore" >> $GITHUB_ENV

      # 10) Sign
      - name: Sign APK
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          "$ANDROID_HOME/build-tools/${{ env.BUILD_TOOLS }}/apksigner" sign \
            --ks "$DEBUG_KEYSTORE" \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out NuYouPlus-Signed.apk \
            "$ALIGNED_APK"
          "$ANDROID_HOME/build-tools/${{ env.BUILD_TOOLS }}/apksigner" verify --verbose NuYouPlus-Signed.apk
          echo "SIGNED_APK=$PWD/NuYouPlus-Signed.apk" >> $GITHUB_ENV
          ls -lh NuYouPlus-Signed.apk

      # 11) Upload artifacts
      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_PREFIX }}-Unsigned.apk
          path: ${{ env.PROJECT_DIR }}/${{ env.UNSIGNED_APK }}
          if-no-files-found: error
          retention-days: 7

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_PREFIX }}-Signed.apk
          path: ${{ env.SIGNED_APK }}
          if-no-files-found: error
          retention-days: 7
