name: Android CI

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      APP_MODULE: app
      BUILD_TOOLS: 34.0.0
      COMPILE_SDK: 34
      APK_PREFIX: NuYouPlus

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          cmdline-tools-version: 11076708
          packages: |
            platform-tools
            platforms;android-34
            build-tools;34.0.0

      - name: Ensure gradlew exists & is executable
        run: |
          ls -lah
          test -f ./gradlew || { echo "gradlew not found at repo root"; exit 1; }
          chmod +x ./gradlew

      - name: Print Android/Java versions
        run: |
          java -version
          adb version || true
          sdkmanager --version || true

      - name: Build (Release if present, else Debug)
        run: |
          set -e
          ./gradlew --no-daemon :${APP_MODULE}:assembleRelease || ./gradlew --no-daemon :${APP_MODULE}:assembleDebug

      - name: Collect APKs
        id: apks
        run: |
          set -e
          OUT="`pwd`/${APP_MODULE}/build/outputs/apk"
          echo "Outputs at $OUT"
          find "$OUT" -type f -name "*.apk" -printf "%s %p\n" | sort -nr | head -n 10
          # pick the largest one as our primary unsigned artifact
          UNSIGNED=$(find "$OUT" -type f -name "*.apk" -printf "%s %p\n" | sort -nr | head -n 1 | cut -d' ' -f2-)
          test -n "$UNSIGNED"
          echo "unsigned=$UNSIGNED" >> $GITHUB_OUTPUT
          echo "Selected unsigned: $UNSIGNED"

      - name: Zipalign (required before signing)
        run: |
          set -e
          UNSIGNED="${{ steps.apks.outputs.unsigned }}"
          ALIGNED="${{ runner.temp }}/${{ env.APK_PREFIX }}-aligned.apk"
          "$ANDROID_HOME/build-tools/${BUILD_TOOLS}/zipalign" -p -f 4 "$UNSIGNED" "$ALIGNED"
          echo "ALIGNED_APK=$ALIGNED" >> $GITHUB_ENV

      - name: Create debug keystore (for CI signing)
        run: |
          set -e
          KEYSTORE="${{ runner.temp }}/debug.keystore"
          keytool -genkeypair -v \
            -keystore "$KEYSTORE" -storepass android \
            -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"
          echo "DEBUG_KEYSTORE=$KEYSTORE" >> $GITHUB_ENV

      - name: Sign APK (apksigner from build-tools)
        run: |
          set -e
          SIGNED="${{ runner.temp }}/${{ env.APK_PREFIX }}-Signed.apk"
          "$ANDROID_HOME/build-tools/${BUILD_TOOLS}/apksigner" sign \
            --ks "$DEBUG_KEYSTORE" \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out "$SIGNED" \
            "$ALIGNED_APK"
          echo "SIGNED_APK=$SIGNED" >> $GITHUB_ENV
          "$ANDROID_HOME/build-tools/${BUILD_TOOLS}/apksigner" verify --verbose "$SIGNED"

      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_PREFIX }}-Unsigned.apk
          path: ${{ steps.apks.outputs.unsigned }}
          if-no-files-found: error
          retention-days: 7

      - name: Upload signed APK (debug keystore)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_PREFIX }}-Signed.apk
          path: ${{ env.SIGNED_APK }}
          if-no-files-found: error
          retention-days: 7
