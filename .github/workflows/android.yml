name: Android CI (fix SDK step)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # ✅ Correct way to install SDK + accept licenses + install packages
      - name: Android SDK
      # Docs: https://github.com/android-actions/setup-android
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          # Optional: print which licenses were accepted
          log-accepted-android-sdk-licenses: true
          # Pin cmdline-tools version (Google’s current stable)
          cmdline-tools-version: 11076708
          # Install exactly what we need
          packages: |
            platform-tools
            platforms;android-35
            build-tools;35.0.0

      - name: Ensure gradlew exists
        run: |
          if [ ! -f gradlew ]; then
            echo "No gradlew found. Creating wrapper…"
            sudo apt-get update && sudo apt-get install -y gradle
            gradle wrapper --gradle-version 8.7 --distribution-type all
          fi
          chmod +x gradlew
          ./gradlew wrapper --gradle-version 8.7 --distribution-type all
          chmod +x gradlew

      - name: Build (Release if present, else Debug)
        run: |
          set -e
          if ./gradlew -q tasks --all | grep -q '^assembleRelease'; then
            ./gradlew --no-daemon clean assembleRelease --stacktrace --info
          else
            echo "::warning::assembleRelease not found; building Debug"
            ./gradlew --no-daemon clean assembleDebug --stacktrace --info
          fi

      - name: Collect APKs
        run: |
          mkdir -p found_apks
          mapfile -t APKS < <(find . -type f -path "*/build/outputs/apk/*/*.apk")
          if [ ${#APKS[@]} -eq 0 ]; then
            echo "::error::No APKs produced"; exit 1
          fi
          ls -lh "${APKS[@]}"
          for a in "${APKS[@]}"; do cp -f "$a" "found_apks/$(basename "$a")"; done

      - name: Upload APKs (raw)
        uses: actions/upload-artifact@v4
        with:
          name: apk-outputs
          path: found_apks/**
          if-no-files-found: error
          retention-days: 14

      - name: Download Uber APK Signer
        run: |
          curl -L -o uber-apk-signer.jar \
            https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar

      - name: Sign the biggest APK
        run: |
          set -e
          BIGGEST=$(ls -S found_apks/*.apk | head -n1)
          mkdir -p signed
          java -jar uber-apk-signer.jar --apks "$BIGGEST" --out signed --overwrite
          SIGNED=$(ls signed/*-Signed.apk | head -n1)
          mv "$SIGNED" signed/NuYouPlus-Signed.apk
          ls -lh signed

      - name: Upload NuYouPlus-Signed.apk
        uses: actions/upload-artifact@v4
        with:
          name: NuYouPlus-Signed.apk
          path: signed/NuYouPlus-Signed.apk
          if-no-files-found: error
          retention-days: 90
