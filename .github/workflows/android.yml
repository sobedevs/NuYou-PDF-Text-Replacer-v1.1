name: Android CI

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ZIP_NAME: NuYou_PDF_Text_Replacer_Signed.zip
      PROJECT_DIR: extracted
      APP_MODULE: app
      ANDROID_HOME: /usr/local/lib/android/sdk
      BUILD_TOOLS: 33.0.2
      PLATFORM_API: 33
      APK_PREFIX: NuYouPlus

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ---------- Install Android SDK (manual, reliable) ----------
      - name: Install Android SDK (manual)
        shell: bash
        run: |
          set -euo pipefail
          sudo mkdir -p "$ANDROID_HOME"
          sudo chown -R $USER:$USER "$ANDROID_HOME"
          mkdir -p "$ANDROID_HOME/cmdline-tools"
          cd "$ANDROID_HOME/cmdline-tools"

          # Download Google cmdline tools (working build)
          curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o cmdtools.zip
          unzip -q cmdtools.zip -d latest
          rm -f cmdtools.zip

          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" --licenses

          # Install platform-tools, chosen platform & build-tools
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" \
            "platform-tools" "platforms;android-${PLATFORM_API}" "build-tools;${BUILD_TOOLS}"

          echo "SDK installed at $ANDROID_HOME"
          "$ANDROID_HOME/platform-tools/adb" version || true

      # ---------- Unpack your Android project ZIP ----------
      - name: Extract NuYou project ZIP
        shell: bash
        run: |
          set -e
          test -f "$ZIP_NAME" || { echo "ZIP not found: $ZIP_NAME"; exit 1; }
          rm -rf "$PROJECT_DIR"
          mkdir -p "$PROJECT_DIR"
          unzip -q "$ZIP_NAME" -d "$PROJECT_DIR"
          echo "Extracted:"
          find "$PROJECT_DIR" -maxdepth 2 -type f -printf "%P\n"

      - name: Confirm Gradle project files
        shell: bash
        run: |
          set -e
          test -f "$PROJECT_DIR/settings.gradle" || { echo "Missing settings.gradle at project root ($PROJECT_DIR)"; exit 1; }
          test -f "$PROJECT_DIR/build.gradle" || { echo "Missing root build.gradle at project root ($PROJECT_DIR)"; exit 1; }
          test -f "$PROJECT_DIR/$APP_MODULE/build.gradle" || { echo "Missing $APP_MODULE/build.gradle"; exit 1; }
          echo "Gradle files present."

      # ---------- Make sure a Gradle wrapper exists ----------
      - name: Generate Gradle wrapper if missing
        shell: bash
        working-directory: extracted
        run: |
          set -e
          if [ ! -f "./gradlew" ]; then
            echo "No gradlew found. Bootstrapping wrapper..."
            GRADLE_VER=8.7
            curl -sSL "https://services.gradle.org/distributions/gradle-${GRADLE_VER}-bin.zip" -o gradle.zip
            unzip -q gradle.zip -d gradle_dist
            rm -f gradle.zip
            ./gradle_dist/gradle-${GRADLE_VER}/bin/gradle -q wrapper --gradle-version "${GRADLE_VER}"
          fi
          chmod +x ./gradlew
          ./gradlew --version

      - name: Print versions
        shell: bash
        run: |
          java -version
          "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --version || true

      # ---------- Build APK (Release â†’ Debug fallback) ----------
      - name: Build APK
        shell: bash
        working-directory: extracted
        run: |
          set -e
          ./gradlew --no-daemon :${APP_MODULE}:assembleRelease || ./gradlew --no-daemon :${APP_MODULE}:assembleDebug

      # ---------- Collect largest unsigned APK ----------
      - name: Collect APKs
        id: apks
        shell: bash
        run: |
          set -e
          OUT="$PROJECT_DIR/${APP_MODULE}/build/outputs/apk"
          echo "Searching in: $OUT"
          find "$OUT" -type f -name "*.apk" -printf "%s %p\n" | sort -nr | head -n 20
          UNSIGNED=$(find "$OUT" -type f -name "*.apk" -printf "%s %p\n" | sort -nr | head -n 1 | cut -d' ' -f2-)
          test -n "$UNSIGNED"
          echo "unsigned=$UNSIGNED" >> "$GITHUB_OUTPUT"
          echo "Selected unsigned: $UNSIGNED"

      # ---------- Zipalign ----------
      - name: Zipalign
        shell: bash
        run: |
          set -e
          UNSIGNED="${{ steps.apks.outputs.unsigned }}"
          ALIGNED="${{ runner.temp }}/${{ env.APK_PREFIX }}-aligned.apk"
          "$ANDROID_HOME/build-tools/${BUILD_TOOLS}/zipalign" -p -f 4 "$UNSIGNED" "$ALIGNED"
          echo "ALIGNED_APK=$ALIGNED" >> "$GITHUB_ENV"

      # ---------- Create debug keystore & Sign ----------
      - name: Create CI debug keystore
        shell: bash
        run: |
          set -e
          KEYSTORE="${{ runner.temp }}/debug.keystore"
          keytool -genkeypair -v \
            -keystore "$KEYSTORE" -storepass android \
            -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"
          echo "DEBUG_KEYSTORE=$KEYSTORE" >> "$GITHUB_ENV"

      - name: Sign APK
        shell: bash
        run: |
          set -e
          SIGNED="${{ runner.temp }}/${{ env.APK_PREFIX }}-Signed.apk"
          "$ANDROID_HOME/build-tools/${BUILD_TOOLS}/apksigner" sign \
            --ks "$DEBUG_KEYSTORE" \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out "$SIGNED" \
            "$ALIGNED_APK"
          "$ANDROID_HOME/build-tools/${BUILD_TOOLS}/apksigner" verify --verbose "$SIGNED"
          echo "SIGNED_APK=$SIGNED" >> "$GITHUB_ENV"

      # ---------- Upload artifacts ----------
      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_PREFIX }}-Unsigned.apk
          path: ${{ steps.apks.outputs.unsigned }}
          if-no-files-found: error
          retention-days: 7

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_PREFIX }}-Signed.apk
          path: ${{ env.SIGNED_APK }}
          if-no-files-found: error
          retention-days: 7
