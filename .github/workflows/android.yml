name: Android CI

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      APP_MODULE: app
      BUILD_TOOLS: 34.0.0
      COMPILE_SDK: 34
      APK_PREFIX: NuYouPlus

    steps:
      # 1. Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Extract NuYou project ZIP
      - name: Extract NuYou Project ZIP
        run: |
          echo "Looking for NuYouPDFTextReplacer_Signed.zip..."
          if [ -f "NuYouPDFTextReplacer_Signed.zip" ]; then
            unzip -q "NuYouPDFTextReplacer_Signed.zip" -d extracted
            echo "Contents extracted to ./extracted"
            ls -R extracted | head -n 20
            if [ -f extracted/gradlew ]; then
              echo "Moving Gradle project to repo root..."
              mv extracted/* ./
            elif [ -d extracted/NuYouPDFTextReplacer_Signed ]; then
              echo "Nested folder detected; moving its contents..."
              mv extracted/NuYouPDFTextReplacer_Signed/* ./
            fi
            echo "Extraction complete."
          else
            echo "ZIP not found; skipping extraction."
          fi

      # 3. Verify Gradle structure
      - name: Verify Android project present
        run: |
          test -f gradlew || { echo "gradlew not found at repo root"; exit 1; }
          test -f settings.gradle -o -f settings.gradle.kts || { echo "settings.gradle missing"; exit 1; }
          chmod +x gradlew

      # 4. Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # 5. Install Android SDK + build-tools
      - name: Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          cmdline-tools-version: 11076708
          packages: |
            platform-tools
            platforms;android-34
            build-tools;34.0.0

      # 6. Debug version check
      - name: Print Android/Java versions
        run: |
          java -version
          adb version || true
          sdkmanager --version || true

      # 7. Build APK (Release or Debug)
      - name: Build (Release if present, else Debug)
        run: |
          ./gradlew --no-daemon :${APP_MODULE}:assembleRelease || \
          ./gradlew --no-daemon :${APP_MODULE}:assembleDebug

      # 8. Collect the largest APK
      - name: Collect APKs
        id: apks
        run: |
          set -e
          OUT="${{ env.APP_MODULE }}/build/outputs/apk"
          echo "Outputs at $OUT"
          find "$OUT" -type f -name "*.apk" -printf "%s %p\n" | sort -nr | head -n 10
          UNSIGNED=$(find "$OUT" -type f -name "*.apk" -printf "%s %p\n" | sort -nr | head -n 1 | cut -d' ' -f2-)
          test -n "$UNSIGNED"
          echo "unsigned=$UNSIGNED" >> $GITHUB_OUTPUT
          echo "Selected unsigned: $UNSIGNED"

      # 9. Zipalign
      - name: Zipalign (prepare before signing)
        run: |
          set -e
          "$ANDROID_HOME/build-tools/${{ env.BUILD_TOOLS }}/zipalign" -p -f 4 \
            "${{ steps.apks.outputs.unsigned }}" aligned.apk
          echo "ALIGNED_APK=$PWD/aligned.apk" >> $GITHUB_ENV

      # 10. Create debug keystore
      - name: Create debug keystore
        run: |
          keytool -genkeypair -v \
            -keystore debug.keystore -storepass android \
            -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=NuYouPlus,O=NuYouPlus,C=US"
          echo "DEBUG_KEYSTORE=$PWD/debug.keystore" >> $GITHUB_ENV

      # 11. Sign APK
      - name: Sign APK (debug key)
        run: |
          SIGNED="NuYouPlus-Signed.apk"
          "$ANDROID_HOME/build-tools/${{ env.BUILD_TOOLS }}/apksigner" sign \
            --ks "$DEBUG_KEYSTORE" \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out "$SIGNED" \
            "$ALIGNED_APK"
          "$ANDROID_HOME/build-tools/${{ env.BUILD_TOOLS }}/apksigner" verify --verbose "$SIGNED"
          echo "SIGNED_APK=$PWD/$SIGNED" >> $GITHUB_ENV

      # 12. Upload unsigned APK
      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_PREFIX }}-Unsigned.apk
          path: ${{ steps.apks.outputs.unsigned }}
          if-no-files-found: error
          retention-days: 7

      # 13. Upload signed APK
      - name: Upload signed APK (debug keystore)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_PREFIX }}-Signed.apk
          path: ${{ env.SIGNED_APK }}
          if-no-files-found: error
          retention-days: 7
