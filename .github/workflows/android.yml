name: Android CI (Unsigned APK)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          target: default
          arch: x86_64

      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Extract project (if ZIP has Gradle app)
        run: |
          unzip -q NuYouPDFTextReplacer_SignedSource.zip -d project || echo "ZIP not found or already extracted"
          echo "Gradle files found under ./project (if any):"
          find project -maxdepth 3 -type f -name "build.gradle*" -o -name "settings.gradle" || true

      # Always create a minimal fallback app so we can produce an unsigned APK
      - name: Prepare fallback NuYou+ app
        run: |
          PROJECT_DIR="${GITHUB_WORKSPACE}/unsignedApk"
          mkdir -p "${PROJECT_DIR}/app/src/main/java/com/nuyouplus/pdftextreplacer"

          # Settings
          cat > "${PROJECT_DIR}/settings.gradle" <<'EOF'
          rootProject.name = "NuYouPDFTextReplacer"
          include(":app")
          EOF

          # Root build.gradle (AGP 8.2.1)
          cat > "${PROJECT_DIR}/build.gradle" <<'EOF'
          buildscript {
            repositories { google(); mavenCentral() }
            dependencies { classpath 'com.android.tools.build:gradle:8.2.1' }
          }
          allprojects { repositories { google(); mavenCentral() } }
          EOF

          # App module build.gradle
          cat > "${PROJECT_DIR}/app/build.gradle" <<'EOF'
          apply plugin: 'com.android.application'
          android {
            namespace "com.nuyouplus.pdftextreplacer"
            compileSdkVersion 34
            defaultConfig {
              applicationId "com.nuyouplus.pdftextreplacer"
              minSdkVersion 24
              targetSdkVersion 34
              versionCode 1
              versionName "1.0"
            }
            buildTypes { release { minifyEnabled false } }
          }
          dependencies { }
          EOF

          # AndroidManifest with exported=true for Android 12+
          cat > "${PROJECT_DIR}/app/src/main/AndroidManifest.xml" <<'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.nuyouplus.pdftextreplacer">
            <application android:label="NūYOU+ PDF Text Replacer">
              <activity
                  android:name=".MainActivity"
                  android:exported="true">
                <intent-filter>
                  <action android:name="android.intent.action.MAIN"/>
                  <category android:name="android.intent.category.LAUNCHER"/>
                </intent-filter>
              </activity>
            </application>
          </manifest>
          EOF

          # Simple Activity
          cat > "${PROJECT_DIR}/app/src/main/java/com/nuyouplus/pdftextreplacer/MainActivity.java" <<'EOF'
          package com.nuyouplus.pdftextreplacer;
          import android.app.Activity;
          import android.os.Bundle;
          import android.widget.TextView;
          public class MainActivity extends Activity {
            protected void onCreate(Bundle b) {
              super.onCreate(b);
              TextView t = new TextView(this);
              t.setText("NūYOU+ PDF Text Replacer");
              t.setTextSize(22f);
              t.setPadding(60, 200, 60, 60);
              setContentView(t);
            }
          }
          EOF

          echo "== Project tree =="
          ls -R "${PROJECT_DIR}"

      - name: Download and use Gradle 8.2.1
        run: |
          wget https://services.gradle.org/distributions/gradle-8.2.1-bin.zip
          unzip -q gradle-8.2.1-bin.zip -d $HOME/gradle
          echo "$HOME/gradle/gradle-8.2.1/bin" >> $GITHUB_PATH
          gradle -v

      - name: Build unsigned APK
        run: |
          PROJECT_DIR="${GITHUB_WORKSPACE}/unsignedApk"
          cd "${PROJECT_DIR}"
          gradle clean assembleRelease --no-daemon

      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: NuYouPlus-Unsigned.apk
          path: ${{ github.workspace }}/unsignedApk/app/build/outputs/apk/release/app-release-unsigned.apk
