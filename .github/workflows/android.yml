name: Android CI

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ZIP_NAME: NuYou_PDF_Text_Replacer_Signed.zip
      PROJECT_DIR: extracted
      APP_MODULE: app
      ANDROID_HOME: /usr/local/lib/android/sdk
      BUILD_TOOLS: 33.0.2
      PLATFORM_API: 33
      APK_PREFIX: NuYouPlus

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ---------- FIXED SDK INSTALL ----------
      - name: Install Android SDK (manual stable)
        run: |
          set -euo pipefail
          sudo mkdir -p "$ANDROID_HOME"
          sudo chown -R $USER:$USER "$ANDROID_HOME"
          mkdir -p "$ANDROID_HOME/cmdline-tools"
          cd "$ANDROID_HOME/cmdline-tools"

          echo "⬇️ Downloading Android commandline tools..."
          curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o cmdtools.zip
          unzip -q cmdtools.zip -d latest
          rm -f cmdtools.zip

          echo "✅ Accepting licenses..."
          printf 'y\n' | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" --licenses || true

          echo "✅ Installing SDK components..."
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" --update || true
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" \
            "platform-tools" "platforms;android-${PLATFORM_API}" "build-tools;${BUILD_TOOLS}" || true

          echo "✅ Android SDK ready at $ANDROID_HOME"

      # ---------- UNZIP PROJECT ----------
      - name: Extract NuYou project ZIP
        run: |
          set -e
          test -f "$ZIP_NAME" || { echo "ZIP not found: $ZIP_NAME"; exit 1; }
          rm -rf "$PROJECT_DIR"
          mkdir -p "$PROJECT_DIR"
          unzip -q "$ZIP_NAME" -d "$PROJECT_DIR"
          echo "Extracted contents:"
          find "$PROJECT_DIR" -maxdepth 2 -type f -printf "%P\n"

      # ---------- VERIFY GRADLE FILES ----------
      - name: Confirm Gradle project files
        run: |
          set -e
          test -f "$PROJECT_DIR/settings.gradle" || { echo "Missing settings.gradle"; exit 1; }
          test -f "$PROJECT_DIR/build.gradle" || { echo "Missing build.gradle"; exit 1; }
          test -f "$PROJECT_DIR/$APP_MODULE/build.gradle" || { echo "Missing app/build.gradle"; exit 1; }
          echo "✅ Gradle project detected."

      # ---------- GENERATE WRAPPER ----------
      - name: Generate Gradle wrapper if missing
        working-directory: extracted
        run: |
          set -e
          if [ ! -f "./gradlew" ]; then
            echo "No gradlew found, creating wrapper..."
            GRADLE_VER=8.7
            curl -sSL "https://services.gradle.org/distributions/gradle-${GRADLE_VER}-bin.zip" -o gradle.zip
            unzip -q gradle.zip -d gradle_dist
            rm -f gradle.zip
            ./gradle_dist/gradle-${GRADLE_VER}/bin/gradle wrapper --gradle-version "${GRADLE_VER}"
          fi
          chmod +x ./gradlew
          ./gradlew --version

      # ---------- PRINT VERSIONS ----------
      - name: Print versions
        run: |
          java -version
          "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --version || true

      # ---------- BUILD APK ----------
      - name: Build APK
        working-directory: extracted
        run: |
          set -e
          ./gradlew --no-daemon :${APP_MODULE}:assembleRelease || ./gradlew --no-daemon :${APP_MODULE}:assembleDebug

      # ---------- COLLECT APK ----------
      - name: Collect APKs
        id: apks
        run: |
          set -e
          OUT="$PROJECT_DIR/${APP_MODULE}/build/outputs/apk"
          echo "Scanning for APKs in: $OUT"
          find "$OUT" -type f -name "*.apk" -printf "%s %p\n" | sort -nr | head -n 20
          UNSIGNED=$(find "$OUT" -type f -name "*.apk" -printf "%s %p\n" | sort -nr | head -n 1 | cut -d' ' -f2-)
          echo "unsigned=$UNSIGNED" >> "$GITHUB_OUTPUT"
          echo "Unsigned APK: $UNSIGNED"

      # ---------- ZIPALIGN ----------
      - name: Zipalign
        run: |
          set -e
          UNSIGNED="${{ steps.apks.outputs.unsigned }}"
          ALIGNED="${{ runner.temp }}/${{ env.APK_PREFIX }}-aligned.apk"
          "$ANDROID_HOME/build-tools/${BUILD_TOOLS}/zipalign" -p -f 4 "$UNSIGNED" "$ALIGNED"
          echo "ALIGNED_APK=$ALIGNED" >> "$GITHUB_ENV"

      # ---------- GENERATE DEBUG KEY ----------
      - name: Create debug keystore
        run: |
          set -e
          KEYSTORE="${{ runner.temp }}/debug.keystore"
          keytool -genkeypair -v \
            -keystore "$KEYSTORE" -storepass android \
            -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"
          echo "DEBUG_KEYSTORE=$KEYSTORE" >> "$GITHUB_ENV"

      # ---------- SIGN APK ----------
      - name: Sign APK
        run: |
          set -e
          SIGNED="${{ runner.temp }}/${{ env.APK_PREFIX }}-Signed.apk"
          "$ANDROID_HOME/build-tools/${BUILD_TOOLS}/apksigner" sign \
            --ks "$DEBUG_KEYSTORE" \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out "$SIGNED" \
            "$ALIGNED_APK"
          "$ANDROID_HOME/build-tools/${BUILD_TOOLS}/apksigner" verify --verbose "$SIGNED"
          echo "SIGNED_APK=$SIGNED" >> "$GITHUB_ENV"

      # ---------- UPLOAD ARTIFACTS ----------
      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_PREFIX }}-Unsigned.apk
          path: ${{ steps.apks.outputs.unsigned }}
          retention-days: 7

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APK_PREFIX }}-Signed.apk
          path: ${{ env.SIGNED_APK }}
          retention-days: 7
