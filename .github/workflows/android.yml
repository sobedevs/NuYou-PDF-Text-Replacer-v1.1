name: Android CI (Unsigned APK)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install unzip & gradle
        run: sudo apt-get update && sudo apt-get install -y unzip gradle

      - name: Extract project
        run: |
          echo "Unzipping..."
          unzip -q NuYouPDFTextReplacer_SignedSource.zip -d project || echo "no zip?"
          cd project
          find . -type f -name "*.gradle*" | head -n 5 || echo "no gradle files?"

      - name: Fallback dummy app build (if no Gradle project found)
        run: |
          mkdir -p ~/unsignedApk/app/src/main/java/com/nuyouplus/pdftextreplacer
          cat <<EOF > ~/unsignedApk/app/src/main/java/com/nuyouplus/pdftextreplacer/MainActivity.java
          package com.nuyouplus.pdftextreplacer;
          import android.app.Activity;
          import android.os.Bundle;
          import android.widget.TextView;
          public class MainActivity extends Activity {
              protected void onCreate(Bundle b) {
                  super.onCreate(b);
                  TextView t = new TextView(this);
                  t.setText("NÅ«YOU+ PDF Text Replacer");
                  setContentView(t);
              }
          }
          EOF

          cat <<EOF > ~/unsignedApk/settings.gradle
          rootProject.name = "NuYouPDFTextReplacer"
          EOF

          cat <<EOF > ~/unsignedApk/app/build.gradle
          apply plugin: 'com.android.application'
          android {
              compileSdkVersion 34
              defaultConfig {
                  applicationId "com.nuyouplus.pdftextreplacer"
                  minSdkVersion 24
                  targetSdkVersion 34
                  versionCode 1
                  versionName "1.0"
              }
              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }
          }
          dependencies {}
          EOF

          cat <<EOF > ~/unsignedApk/build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { classpath 'com.android.tools.build:gradle:8.2.1' }
          }
          allprojects { repositories { google(); mavenCentral() } }
          apply from: "app/build.gradle"
          EOF

      - name: Build unsigned APK
        working-directory: ~/unsignedApk
        run: |
          gradle clean assembleRelease --no-daemon

      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: NuYouPlus-Unsigned.apk
          path: ~/unsignedApk/app/build/outputs/apk/release/app-release-unsigned.apk
